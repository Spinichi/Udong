# 우동 (UDONG) 포팅 매뉴얼

## 1. 프로젝트 개요

- **프로젝트명**: 우동 (동아리 관리 시스템)
- **개발기간**: 2024년
- **팀구성**: 백엔드 3명, 프론트엔드 3명

## 2. 개발 환경

### 2.1 백엔드 (Spring Boot)

- **JVM**: OpenJDK 21
- **프레임워크**: Spring Boot 3.5.5
- **빌드 도구**: Gradle 8.x
- **WAS**: Embedded Tomcat (Spring Boot 내장)
- **주요 의존성**:
  - Spring Data JPA
  - Spring Security
  - Spring WebSocket
  - JWT (io.jsonwebtoken:jjwt-api:0.12.5)
  - AWS SDK S3
  - Swagger OpenAPI 3.0

### 2.2 프론트엔드 (React)

- **Node.js**: 20.x (Alpine)
- **React**: 19.1.1
- **TypeScript**: 5.8.3
- **빌드 도구**: Vite 7.1.5
- **상태관리**: Zustand 5.0.8
- **스타일링**: Tailwind CSS 3.4.17
- **HTTP 클라이언트**: fetch API

### 2.3 웹서버 및 리버스 프록시

- **웹서버**: Nginx (Alpine 이미지)
- **SSL/TLS**: Let's Encrypt (Certbot)
- **포트**: 80 (HTTP), 443 (HTTPS)

### 2.4 데이터베이스

- **DBMS**: MySQL 8.x
- **커넥션 풀**: HikariCP
  - maximum-pool-size: 3
  - minimum-idle: 1
  - connection-timeout: 20000ms

### 2.5 CI/CD 및 모니터링

- **CI/CD**: Jenkins (LTS)
- **컨테이너**: Docker & Docker Compose
- **모니터링**: Prometheus + Grafana + Loki + Promtail
- **로그 수집**: Node Exporter

## 3. 서버 환경

### 3.1 서버 사양

- **OS**: Ubuntu (Host)
- **컨테이너 런타임**: Docker
- **프로젝트 경로**: `/home/ubuntu/udong`
- **Jenkins 포트**: 8090
- **Prometheus 포트**: 9090

### 3.2 네트워크 구성

```
[Internet]
    ↓ 80/443
[Nginx (리버스 프록시)]
    ↓
[Frontend Container] + [Backend Container]
    ↓
[MySQL Database]
```

## 4. 빌드 환경

### 4.1 백엔드 빌드

```bash
# Gradle 빌드
./gradlew bootJar --no-daemon

# Docker 빌드
docker-compose build --no-cache business-api
```

### 4.2 프론트엔드 빌드

```bash
# npm 빌드
npm install
npm run build

# Docker 빌드
docker-compose build --no-cache frontend
```

## 5. 환경 변수

### 5.1 백엔드 환경변수 (.env)

백엔드의 주요 환경변수는 `backend/business/.env` 파일에 정의:

```properties
# 데이터베이스 설정
SPRING_DATASOURCE_URL=jdbc:mysql://[host]:[port]/[database]
SPRING_DATASOURCE_USERNAME=[username]
SPRING_DATASOURCE_PASSWORD=[password]

# JWT 설정
JWT_SECRET_KEY=[jwt_secret_key]

# AES 암호화 키
APP_AES_KEY_B64=[aes_encryption_key]

# AWS 설정
AWS_ACCESS_KEY_ID=[aws_access_key]
AWS_SECRET_ACCESS_KEY=[aws_secret_key]

# 외부 API 키
FIN_API_KEY=[financial_api_key]
IMA_GMS_KEY=[image_generation_api_key]
```

### 5.2 프론트엔드 환경변수 (.env)

```properties
VITE_API_BASE_URL=[backend_api_url]
```

### 5.3 Docker Compose 환경변수

```yaml
environment:
  - SPRING_PROFILES_ACTIVE=prod
  - SERVER_PORT=8080
  - TZ=Asia/Seoul
```

## 6. 배포 프로세스

### 6.1 Jenkins 자동 배포

1. **트리거**: GitLab dev 브랜치 push
2. **변경 감지**: frontend/ 또는 backend/business/ 디렉토리 변경사항 자동 감지
3. **환경 파일 준비**: Jenkins Credentials에서 .env 파일 자동 배포
4. **병렬 빌드**: Frontend와 Backend 동시 빌드
5. **무중단 배포**: Docker Compose를 통한 개별 서비스 재시작

### 6.2 배포 특이사항

- **환경 파일 관리**: Jenkins Credentials를 통한 보안 환경변수 관리
- **캐시 무효화**: `--no-cache` 옵션으로 최신 변경사항 반영
- **의존성 분리**: `--no-deps` 옵션으로 개별 서비스 재시작
- **자동 정리**: 배포 후 사용하지 않는 Docker 이미지 자동 정리

## 7. 주요 설정 파일 목록

### 7.1 백엔드 설정

- `backend/business/build.gradle` - Gradle 빌드 설정
- `backend/business/src/main/resources/application.yml` - Spring Boot 설정
- `backend/business/.env` - 환경변수 (민감정보)
- `backend/business/Dockerfile` - Docker 빌드 설정

### 7.2 프론트엔드 설정

- `frontend/package.json` - NPM 의존성 및 스크립트
- `frontend/.env` - 환경변수
- `frontend/Dockerfile` - Docker 빌드 설정
- `frontend/tailwind.config.js` - Tailwind CSS 설정

### 7.3 인프라 설정

- `docker-compose.yml` - 전체 서비스 오케스트레이션
- `Jenkinsfile` - CI/CD 파이프라인 정의
- `nginx/nginx.conf` - Nginx 웹서버 설정
- `nginx/conf.d/` - Nginx 사이트별 설정
- `prometheus/prometheus.yml` - Prometheus 모니터링 설정

## 8. 데이터베이스 정보

### 8.1 연결 정보

- **드라이버**: MySQL Connector/J
- **URL 형식**: `jdbc:mysql://[host]:[port]/[database]?useSSL=true&serverTimezone=Asia/Seoul`
- **커넥션 풀**: HikariCP (최대 3개 연결)

### 8.2 JPA 설정

- **DDL 모드**: `update` (운영환경에서는 `validate` 권장)
- **SQL 로깅**: 개발환경에서 활성화
- **방언**: MySQL8Dialect

### 8.3 데이터베이스 백업

#### 8.3.1 자동 백업 시스템
- **백업 방식**: mysqldump를 통한 전체 덤프 백업
- **저장소**: AWS S3 (`ssafy-udong-project-mysql-backup` 버킷)
- **압축**: gzip 압축 적용
- **스케줄**: cron을 통한 6시간마다 자동 백업

#### 8.3.2 백업 스케줄
```bash
# crontab 설정 (6시간마다: 02:00, 08:00, 14:00, 20:00)
0 2,8,14,20 * * * TZ=Asia/Seoul /home/ubuntu/simple_backup.sh
```

#### 8.3.3 백업 스크립트 (`simple_backup.sh`)
```bash
#!/bin/bash
S3_BUCKET="ssafy-udong-project-mysql-backup"
DATE=$(TZ=Asia/Seoul date +%Y%m%d_%H%M%S)
BACKUP_FILE="backup_$DATE.sql.gz"

# MySQL 백업 → 압축 → S3 업로드 (원스텝)
mysqldump -h ssafy-mysql-db.mysql.database.azure.com \
          -P 3306 \
          -u S13P21A310 \
          -p1234 \
          --single-transaction \
          --routines \
          --triggers \
          --no-tablespaces \
          --skip-lock-tables \
          --set-gtid-purged=OFF \
          S13P21A310 | gzip | aws s3 cp - s3://$S3_BUCKET/$BACKUP_FILE
```

#### 8.3.4 백업 옵션 설명
- `--single-transaction`: InnoDB 테이블 일관성 보장
- `--routines`: 저장 프로시저, 함수 포함
- `--triggers`: 트리거 포함
- `--no-tablespaces`: 테이블스페이스 정보 제외
- `--skip-lock-tables`: 테이블 락 스킵 (Azure MySQL 권장)
- `--set-gtid-purged=OFF`: GTID 관련 문제 방지

## 9. 외부 서비스 연동

### 9.1 AWS S3

- **용도**: 파일 업로드 (영수증 이미지 등)
- **리전**: ap-southeast-2 (시드니)

### 9.2 금융 API

- **베이스 URL**: https://finopenapi.ssafy.io/ssafy/api/v1
- **기관코드**: 00100
- **앱번호**: 001

### 9.3 이미지 생성 API

- **서비스**: Google Imagen 3.0
- **엔드포인트**: GMS SSAFY API

## 10. 포트 정보

| 서비스      | 포트    | 설명                     |
| ----------- | ------- | ------------------------ |
| Nginx       | 80, 443 | HTTP/HTTPS 웹서버        |
| Backend API | 8080    | Spring Boot (내부)       |
| Jenkins     | 8090    | CI/CD 서버               |
| Prometheus  | 9090    | 모니터링 메트릭          |
| Grafana     | 3000    | 모니터링 대시보드 (내부) |

## 11. 보안 고려사항

### 11.1 환경변수 보안

- 모든 민감정보는 .env 파일로 분리
- Jenkins Credentials를 통한 안전한 환경변수 관리
- Git에서 .env 파일 제외 (.gitignore)

### 11.2 컨테이너 보안

- 비-root 사용자로 Spring Boot 애플리케이션 실행
- 최소한의 권한으로 컨테이너 실행

### 11.3 API 보안

- JWT 토큰 기반 인증
- AES256 암호화를 통한 민감 데이터 보호
- CORS 설정을 통한 요청 제한

## 12. 트러블슈팅

### 12.1 빌드 실패 시

1. Docker 캐시 정리: `docker system prune -f`
2. 환경변수 파일 확인: `.env` 파일 존재 여부
3. 로그 확인: `docker-compose logs [service_name]`

### 12.2 배포 실패 시

1. Jenkins 로그 확인
2. 컨테이너 상태 확인: `docker-compose ps`
3. 환경변수 파일 권한 확인

### 12.3 성능 이슈 시

- Prometheus 메트릭을 통한 성능 모니터링
- Grafana 대시보드를 통한 시각화된 모니터링
- 데이터베이스 커넥션 풀 조정

---
